{% load static %}
{% load sass_tags %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome CDN -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" >
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Faculty Dashboard</title>
    <link rel="stylesheet" href="{% sass_src 'scss/faculty_dashboard.scss' %}">
</head>

<body>
    <div class="dashboard-container">

        <!-- Top Navigation Bar -->
        <header class="top-bar">
        <div class="logo">
            <img src="{% static 'images/csn_logo.png' %}" alt="Website Logo">
        </div>
        <div class="top-center">Faculty Dashboard</div>
        <div class="account-area">
            <a href="{% url 'logout' %}">Log Out</a>
        </div>
        </header>

        <!-- Sidebar + Main Content Area -->
        <div class="main-layout">

            <nav class="sidebar">
                <ul>
                    <!-- Add more links as needed -->
                    <li><a href="#" id="dashboard" class="nav-link active" onclick="showDashboard()">
                        <span class="icon"><i class="fas fa-house"></i></span>
                        <span class="label">Dashboard</span>
                    </a></li>

                    <li><a href="#" id="createExam" class="nav-link" onclick="showCreateExam()">
                        <span class="icon"><i class="fas fa-pen-to-square"></i></span>
                        <span class="label">Create an Exam</span>
                    </a></li>

                    <li><a href="#" id="editExam" class="nav-link" onclick="showEditExam()">
                        <span class="icon"><i class="fas fa-pen-to-square"></i></span>
                        <span class="label">Edit an Exam</span>
                    </a></li>

                </ul>
            </nav>

            <main class="main-window">
                <div class="content-card">
                    <!-- Dynamic exam cards goes here -->

                    <div id="dashboard-card">
                        <h1>Welcome, {{ first_name }} {{ last_name }}</h1>

                        <!-- Filters -->
                        <div class="filters-row">
                            <div class="filters">
                                <div class="filter-group">
                                    <label for="startDate-dashboard">From:</label>
                                    <input type="date" id="startDate-dashboard" onchange="filterExams('dashboard')">
                                </div>

                                <div class="filter-group">
                                    <label for="endDate-dashboard">To:</label>
                                    <input type="date" id="endDate-dashboard" onchange="filterExams('dashboard')">
                                </div>

                                <div class="filter-group">
                                    <label for="campusFilter-dashboard">Campus:</label>
                                    <select id="campusFilter-dashboard" onchange="filterExams('dashboard')">
                                        <option value="all">All Campuses</option>
                                        <option value="Henderson">Henderson</option>
                                        <option value="North Las Vegas">North Las Vegas</option>
                                        <option value="West Charleston">West Charleston</option>
                                    </select>
                                </div>

                                <div class="filter-group">
                                    <label for="subjectFilter-dashboard">Subject:</label>
                                    <select id="subjectFilter-dashboard" onchange="filterExams('dashboard')">
                                        <option value="all">All Subjects</option>
                                        <option value="MATH">MATH</option>
                                        <option value="ENG">ENG</option>
                                        <option value="BIO">BIO</option>
                                        <!-- Add more subjects as needed -->
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Dynamic Exam List -->
                        <div id="dashboard-panel"></div>

                    </div>

                    <div id="createExam-card" class="hidden">
                        <h1>Create an Exam</h1>

                        <!-- Dynamic Exam List -->
                        <div id="createExam-panel"></div>

                    </div>

                    <div id="editExam-card" class="hidden">
                        <h1>Edit an Exam</h1>

                        <!-- Dynamic Exam List -->
                        <div id="editExam-panel"></div>

                    </div>

                </div>
            </main>
        </div>
    </div>

    <script>

        function clearActiveLinks() {
            document.querySelectorAll(".nav-link").forEach(link => {
                link.classList.remove("active");
            });

            // Hide all cards
            document.querySelectorAll(".content-card > div").forEach(panel => {
                panel.classList.add("hidden");
            });
        }

        function showDashboard() {
            clearActiveLinks();
            document.getElementById("dashboard").classList.add("active");
            document.getElementById("dashboard-card").classList.remove("hidden");
            document.getElementById("createExam-card").classList.add("hidden");
            document.getElementById("editExam-card").classList.add("hidden");

            refreshFacultyDashboard();
        }


        function showCreateExam() {
            clearActiveLinks();
            document.getElementById("createExam").classList.add("active");
            document.getElementById("dashboard-card").classList.add("hidden");
            document.getElementById("createExam-card").classList.remove("hidden");
            document.getElementById("editExam-card").classList.add("hidden");

            refreshCreateExamPanel();
        }

        function showEditExam() {
            clearActiveLinks();
            document.getElementById("editExam").classList.add("active");
            document.getElementById("dashboard-card").classList.add("hidden");
            document.getElementById("createExam-card").classList.add("hidden");
            document.getElementById("editExam-card").classList.remove("hidden");

        }

        document.addEventListener("DOMContentLoaded", function () {
            // Make sure dashboard is shown first
            showDashboard();
            refreshFacultyDashboard(); // Refresh exam cards
        });

        function filterExams(panel) {
            const selectedCampus = document.getElementById(`campusFilter-${panel}`).value;
            const startDateInput = document.getElementById(`startDate-${panel}`);
            const endDateInput = document.getElementById(`endDate-${panel}`);
            const selectedSubject = document.getElementById(`subjectFilter-${panel}`)?.value || "all";
            const hideFull = document.getElementById("hideFullCheckbox")?.checked ?? true;


            let startDate = null;
            let endDate = null;

            if (startDateInput?.value) {
                const sParts = startDateInput.value.split("-");
                startDate = new Date(sParts[0], sParts[1] - 1, sParts[2]); // local midnight
            }

            if (endDateInput?.value) {
                const eParts = endDateInput.value.split("-");
                endDate = new Date(eParts[0], eParts[1] - 1, eParts[2]);
                endDate.setHours(23, 59, 59, 999); // include full end-of-day
            }

            const examCards = document.querySelectorAll(`#${panel}-card .exam-card`);

            examCards.forEach(card => {
                const cardCampus = card.getAttribute('data-campus');
                const cardDateStr = card.getAttribute('data-date');
                const cardSubject = card.getAttribute('data-subject');

                if (!cardDateStr) return; // Skip if date is missing

                let cardDate = null;
                if (cardDateStr && cardDateStr.includes("-")) {
                    const parts = cardDateStr.split("-");
                    if (parts.length === 3) {
                        cardDate = new Date(parts[0], parts[1] - 1, parts[2]);
                    }
                }

                if (!cardDate || isNaN(cardDate.getTime())) {
                    console.warn("Invalid cardDate:", cardDateStr);
                    card.style.display = 'none';
                    return;
                }


                const campusMatches = (selectedCampus === "all" || cardCampus === selectedCampus);
                const subjectMatches = (selectedSubject === "all" || cardSubject === selectedSubject);

                const isFull = card.getAttribute('data-full') === "true";
                const fullMatches = !hideFull || !isFull;

                let dateMatches = true;
                if (startDate && cardDate < startDate) dateMatches = false;
                if (endDate && cardDate > endDate) dateMatches = false;

                console.log("CARD:", cardDate.toISOString(),
                            "| Start:", startDate?.toISOString(),
                            "| End:", endDate?.toISOString(),
                            "| dateMatches:", dateMatches);

                if (campusMatches && dateMatches && subjectMatches && fullMatches) {
                    card.style.removeProperty('display');
                } else {
                    card.style.display = 'none';
                }

            });
        }

        function moveToEditPanel(examId) {
            fetch(`/get_single_edit_exam_form/${examId}/`)
                .then(res => res.json())
                .then(data => {
                    const editPanel = document.querySelector("#editExam-panel");

                    if (editPanel.querySelector(".exam-card")) {
                        // Already has at least one exam-card, so append
                        editPanel.innerHTML += data.html;
                    } else {
                        // First card â€” set the full grid container
                        editPanel.innerHTML = data.html;
                    }

                    showEditExam();
                })
                .catch(err => {
                    console.error("Error loading edit form:", err);
                    showSnackbar("Failed to load edit form.");
                });
        }


        function saveExamChanges(examId) {
            const card = document.querySelector(`.exam-card[data-exam-id="${examId}"]`);
            const formData = {
                exam_subject: card.querySelector('input[name="exam_subject"]').value,
                exam_number: card.querySelector('input[name="exam_number"]').value,
                exam_date: card.querySelector('input[name="exam_date"]').value,
                exam_time: card.querySelector('input[name="exam_time"]').value,
                location: card.querySelector('input[name="location"]').value,
                building: card.querySelector('input[name="building"]').value,
                room_number: card.querySelector('input[name="room_number"]').value,
                max_seats: card.querySelector('input[name="max_seats"]').value,
                status: card.querySelector('select[name="status"]').value,
            };

            fetch(`/update_exam/${examId}/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken"),
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: JSON.stringify(formData)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Remove the edited form from the edit panel
                    if (card) card.remove();

                    // Refresh the dashboard so the updates are reflected
                    refreshFacultyDashboard();

                    refreshEditExamPanel();

                    // Show success message
                    showSnackbar("Exam updated!");
                } else {
                    showSnackbar(data.error || "Failed to save changes.");
                }
            })
            .catch(err => {
                console.error("Error saving changes:", err);
                showSnackbar("Error saving changes.");
            });
        }


        function deleteExam(examId) {
            if (!confirm("Are you sure you want to delete this exam?")) return;

            fetch(`/faculty/exam/delete/${examId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                    "X-Requested-With": "XMLHttpRequest"
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showSnackbar("Exam deleted.");
                    const card = document.querySelector(`.exam-card[data-exam-id="${examId}"]`);
                    if (card) card.remove();
                    refreshFacultyDashboard(); // Optional if you want to update the main view too
                    refreshEditExamPanel();
                } else {
                    showSnackbar(data.error || "Failed to delete exam.");
                }
            })
            .catch(err => {
                console.error("Error deleting exam:", err);
                showSnackbar("Error deleting exam.");
            });
        }


        function refreshFacultyDashboard() {
            console.log("REFRESHING FACULTY DASHBOARD PANEL");

            const examList = document.querySelector("#dashboard-panel");

            // Clear the panel immediately
            if (examList) {
                examList.innerHTML = "";

                // Create and insert the spinner directly into the panel
                const spinnerWrapper = document.createElement("div");
                spinnerWrapper.className = "spinner-wrapper";

                const spinnerContainer = document.createElement("div");
                spinnerContainer.className = "spinner-container";

                const spinner = document.createElement("div");
                spinner.className = "spinner";

                spinnerContainer.appendChild(spinner);
                spinnerWrapper.appendChild(spinnerContainer);
                examList.appendChild(spinnerWrapper);
            }

            // Fetch and replace content
            setTimeout(() => {
                fetch("/fetch_faculty_exam_grid/")
                    .then(response => response.json())
                    .then(data => {
                        if (examList && data.html) {
                            examList.innerHTML = data.html;
                            filterExams("dashboard");
                        }
                    })
                    .catch(err => {
                        console.error("Error loading dashboard exam list:", err);
                    });
            }, 0);
        }

        function refreshCreateExamPanel() {
            console.log("REFRESHING CREATE EXAM PANEL");

            const panel = document.querySelector("#createExam-panel");

            if (panel) {
                panel.innerHTML = "";

                const spinnerWrapper = document.createElement("div");
                spinnerWrapper.className = "spinner-wrapper";

                const spinnerContainer = document.createElement("div");
                spinnerContainer.className = "spinner-container";

                const spinner = document.createElement("div");
                spinner.className = "spinner";

                spinnerContainer.appendChild(spinner);
                spinnerWrapper.appendChild(spinnerContainer);
                panel.appendChild(spinnerWrapper);
            }

            // Fetch the form
            setTimeout(() => {
                fetch("/fetch_add_exam_form/")
                    .then(res => res.json())
                    .then(data => {
                        if (panel && data.html) {
                            panel.innerHTML = data.html;
                            handleAddExamFormSubmission();
                        }
                    })
                    .catch(err => {
                        console.error("Error loading create exam form:", err);
                    });
            }, 0);
        }


        function refreshEditExamPanel() {
            console.log("REFRESHING EDIT EXAM PANEL");

            const panel = document.querySelector("#editExam-panel");

            if (panel) {
                panel.innerHTML = "";

                const spinnerWrapper = document.createElement("div");
                spinnerWrapper.className = "spinner-wrapper";

                const spinnerContainer = document.createElement("div");
                spinnerContainer.className = "spinner-container";

                const spinner = document.createElement("div");
                spinner.className = "spinner";

                spinnerContainer.appendChild(spinner);
                spinnerWrapper.appendChild(spinnerContainer);
                panel.appendChild(spinnerWrapper);
            }

            setTimeout(() => {
                fetch("/fetch_edit_exam_form/")
                    .then(res => res.json())
                    .then(data => {
                        if (panel && data.html) {
                            panel.innerHTML = data.html;
                        }
                    })
                    .catch(err => {
                        console.error("Error loading edit exam list:", err);
                    });
            }, 0);
        }

        function handleAddExamFormSubmission() {
            const form = document.querySelector("#add-exam-form");

            if (form) {
                console.log("Found the add exam form and attached event listener");
                form.addEventListener("submit", function (e) {
                    e.preventDefault();

                    const formData = new FormData(form);

                    fetch("/ajax_add_exam/", {
                        method: "POST",
                        headers: {
                            "X-Requested-With": "XMLHttpRequest",
                            "X-CSRFToken": getCookie("csrftoken")
                        },
                        body: formData
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            showSnackbar("Exam created successfully.");
                            refreshFacultyDashboard(); // Optional: update dashboard
                            form.reset();
                        } else {
                            showSnackbar("Failed to create exam.");
                            console.error(data.errors);
                        }
                    })
                    .catch(err => {
                        console.error("AJAX error:", err);
                    });
                });
            } else {
                console.warn("Could not find #add-exam-form in the DOM");
            }
        }


        function updateExamCount() {
            fetch("/get_exam_count/")
                .then(res => res.json())
                .then(data => {
                    document.getElementById("exam-count").textContent = data.count;
                });
        }

        function showSnackbar(message) {
            const snackbar = document.getElementById("snackbar");
            snackbar.textContent = message;

            snackbar.classList.remove("show"); // Reset in case it's already showing
            void snackbar.offsetWidth;         // Force reflow
            snackbar.classList.add("show");

            setTimeout(() => {
                snackbar.classList.remove("show");
            }, 3000);
        }

        // CSRF helper for Django
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === name + "=") {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>

    <div id="snackbar"></div>

</body>
</html>