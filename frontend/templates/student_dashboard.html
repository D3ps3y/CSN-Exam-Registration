{% load static %}
{% load sass_tags %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome CDN -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" >
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Exam Dashboard</title>
    <link rel="stylesheet" href="{% sass_src 'scss/student_dashboard.scss' %}">
</head>

<body>
    <div class="dashboard-container">

        <!-- Top Navigation Bar -->
        <header class="top-bar">
        <div class="logo">
            <img src="{% static 'images/csn_logo.png' %}" alt="Website Logo">
        </div>
        <div class="top-center">Student Dashboard</div> <!-- Or Campus Name, Date, etc. -->
        <div class="account-area">
            <a href="{% url 'logout' %}">Log Out</a>
        </div>
        </header>

        <!-- Sidebar + Main Content Area -->
        <div class="main-layout">

            <nav class="sidebar">
                <ul>
                    <!-- Add more links as needed -->
                    <li><a href="#" id="dashboard" class="nav-link active" onclick="showDashboard()">
                        <span class="icon"><i class="fas fa-house"></i></span>
                        <span class="label">Dashboard</span>
                    </a></li>

                    <li><a href="#" id="registration" class="nav-link" onclick="showRegistration()">
                        <span class="icon"><i class="fas fa-pen-to-square"></i></span>
                        <span class="label">Register for an Exam</span>
                    </a></li>

                    <li><a href="#" id="confirmation" class="nav-link" onclick="showConfirmations()">
                        <span class="icon"><i class="fas fa-circle-check"></i></span>
                        <span class="label">Exam Confirmation</span>
                    </a></li>

                    <li><a href="#" id="bookings" class="nav-link" onclick="showBookings()">
                        <span class="icon"><i class="fas fa-file-alt"></i></span>
                        <span class="label">My Bookings</span>
                    </a></li>

                </ul>
            </nav>

            <main class="main-window">
                <div class="content-card">
                    <!-- Dynamic exam cards or booking UI goes here -->
                    <div id="dashboard-card">

                        <h1>Welcome, {{ first_name }} {{ last_name }}</h1>

                        <div class="dashboard-content">

                            <!-- Top Metric Row -->
                            <div class="dashboard-metrics">
                                <div class="metric-card">
                                    <h3>Registered Exams</h3>
                                    <p>{{ registered_count }} Registered</p>
                                </div>

                                <div class="metric-card">
                                    <h3>Upcoming Exam</h3>
                                    {% if upcoming_exam %}
                                        <p>{{ upcoming_exam.exam_subject }} {{ upcoming_exam.exam_number }}</p>
                                        <p>{{ upcoming_exam.exam_date }}<br>
                                           {{ upcoming_exam.exam_time|time:"g:i a" }}</p>
                                        <p>{{ upcoming_exam.location }} ({{ upcoming_exam.building }})</p>
                                    {% else %}
                                        <p>No upcoming exam</p>
                                    {% endif %}
                                </div>

                                <div class="metric-card">
                                    <h3>Pending Confirmations</h3>
                                    <p>{{ pending_count }} Pending</p>
                                </div>
                            </div>

                            <!-- Announcements Section -->
                            <div class="announcement-card">
                                <h3><i class="fas fa-bullhorn" style="margin-right: 0.4rem;"></i>Announcements</h3>
                                <div class="announcement-rotator">
                                    <div id="announcement-text">Loading announcements...</div>

                                    <div class="announcement-controls">
                                        <button onclick="prevAnnouncement()">◀</button>
                                        <button onclick="nextAnnouncement()">▶</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Rules Section -->
                            <div class="rules-section">
                                <div class="rules-card">
                                    <h3>Student Rules</h3>
                                    <ol>
                                        <li>
                                            <strong>Maximum Exams:</strong>
                                            <ul>
                                                <li>You may register for up to 3 exams at a time.</li>
                                            </ul>
                                        </li>

                                        <li>
                                            <strong>Session Capacity:</strong>
                                            <ul>
                                                <li>Each exam session is limited to 20 students. Once full, the exam will be hidden from the available list</li>
                                            </ul>
                                        </li>

                                        <li>
                                            <strong>No Duplicate Registrations:</strong>
                                            <ul>
                                                <li>You cannot register for the same exam (same course & number) more than once</li>
                                            </ul>
                                        </li>

                                        <li>
                                            <strong>Modifying Bookings:</strong>
                                            <ul>
                                                <li>You may cancel a booking from the “My Bookings” section before the cancellation deadline</li>
                                            </ul>
                                        </li>

                                        <li>
                                            <strong>Confirmation Required:</strong>
                                            <ul>
                                                <li>Your exam registration is not final until you confirm it in "Exam Confirmations"</li>
                                            </ul>
                                        </li>

                                        <li>
                                            <strong>Check for Updates:</strong>
                                            <ul>
                                                <li>Make sure to check the dashboard frequently for any schedule changes or new exam postings</li>
                                            </ul>
                                        </li>
                                    </ol>
                                </div>

                                <div class="rules-card">
                                    <h3>How to Register for an Exam</h3>
                                    <ol>
                                        <li>
                                            <strong>Browse Available Exams:</strong>
                                            <ul>
                                                <li>Click on the sidebar option "Register for an Exam" to get started!</li>
                                                <li>Use the filter options at the top of the page to search by subject, campus, and exam date</li>
                                                <li>Exams that are fully booked will be marked as "Full" and cannot be selected</li>
                                            </ul>
                                        </li>

                                        <li>
                                            <strong>Select and Confirm Your Exam:</strong>
                                            <ul>
                                                <li>Click "Select" on your chosen exam.</li>
                                                <li>You’ll be informed that the exam has been moved to "Exam Confirmation"</li>
                                                <li>Click on the sidebar option "Exam Confirmation" to confirm selected exams</li>
                                                <li>Review the details and click "Confirm" to finalize your booking</li>
                                            </ul>
                                        </li>

                                        <li>
                                            <strong>Check Your Bookings:</strong>
                                            <ul>
                                                <li>Go to the “My Bookings” sidebar option to view your current registrations</li>
                                                <li>You can see the exam location, date, time, and the option to cancel the booking</li>
                                            </ul>
                                        </li>
                                    </ol>

                                    <div class="card-footer">
                                        <hr>
                                        <p>If you need help, please contact the CSN Testing Center for assistance.</p>
                                        <a href="#" class="contact-link"><i class="fas fa-headset"></i> Contact Support</a>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="registration-card" class="hidden">
                        <h1>Exam Registration</h1>

                        <!-- Filters -->
                        <div class="filters-row">
                            <div class="filters">
                                <div class="filter-group">
                                    <label for="startDate-registration">From:</label>
                                    <input type="date" id="startDate-registration" onchange="filterExams('registration')">
                                </div>

                                <div class="filter-group">
                                    <label for="endDate-registration">To:</label>
                                    <input type="date" id="endDate-registration" onchange="filterExams('registration')">
                                </div>

                                <div class="filter-group">
                                    <label for="campusFilter-registration">Campus:</label>
                                    <select id="campusFilter-registration" onchange="filterExams('registration')">
                                        <option value="all">All Campuses</option>
                                        <option value="Henderson">Henderson</option>
                                        <option value="North Las Vegas">North Las Vegas</option>
                                        <option value="West Charleston">West Charleston</option>
                                    </select>
                                </div>

                                <div class="filter-group">
                                    <label for="subjectFilter-registration">Subject:</label>
                                    <select id="subjectFilter-registration" onchange="filterExams('registration')">
                                        <option value="all">All Subjects</option>
                                        <option value="ABDY">Auto Body</option>
                                        <option value="AC">Air Conditioning Technology</option>
                                        <option value="ACC">Accounting</option>
                                        <option value="ADT">Architectural Design Technology</option>
                                        <option value="AES">Aerospace Studies</option>
                                        <option value="AIT">Apprenticeship Industrial Technology</option>
                                        <option value="ALS">Applied Laboratory Sciences</option>
                                        <option value="AM">American Sign Language</option>
                                        <option value="ANIM">Animation</option>
                                        <option value="ANTH">Anthropology</option>
                                        <option value="ARA">Arabic</option>
                                        <option value="ARM">Armenian</option>
                                        <option value="ART">Art</option>
                                        <option value="ASB">Asian Studies</option>
                                        <option value="AST">Astronomy</option>
                                        <option value="AUTO">Automotive Technology</option>
                                        <option value="AV">Aviation</option>
                                        <option value="BIOL">Biology</option>
                                        <option value="BRL">Barbering</option>
                                        <option value="BUS">Business</option>
                                        <option value="CADD">Computer Aided Drafting and Design</option>
                                        <option value="CAPS">Computer Applications</option>
                                        <option value="CEE">Civil and Environmental Engineering</option>
                                        <option value="CEM">Construction Engineering Management</option>
                                        <option value="CHEM">Chemistry</option>
                                        <option value="CHI">Chinese</option>
                                        <option value="CHS">Chicano Studies</option>
                                        <option value="CIT">Computing and Information Technology</option>
                                        <option value="CLS">Clinical Laboratory Sciences</option>
                                        <option value="CMA">Clinical Medical Assisting</option>
                                        <option value="COM">Communication</option>
                                        <option value="CONS">Construction Management</option>
                                        <option value="COT">Computing Technologies</option>
                                        <option value="CPD">Career Personal Development</option>
                                        <option value="CPE">Computer Engineering</option>
                                        <option value="CPT">Carpentry</option>
                                        <option value="CRJ">Criminal Justice</option>
                                        <option value="CRS">Crisis Response Studies</option>
                                        <option value="CS">Computer Science</option>
                                        <option value="CSCO">Cisco Networking</option>
                                        <option value="CSEC">Cybersecurity</option>
                                        <option value="CUL">Culinary Arts</option>
                                        <option value="DA">Dental Assisting</option>
                                        <option value="DAN">Dance</option>
                                        <option value="DH">Dental Hygiene</option>
                                        <option value="DT">Diesel Technology</option>
                                        <option value="DWA">Digital Web Applications</option>
                                        <option value="DWF">Digital Web Foundations</option>
                                        <option value="ECE">Early Childhood Education</option>
                                        <option value="ECON">Economics</option>
                                        <option value="EDU">Education</option>
                                        <option value="EE">Electrical Engineering</option>
                                        <option value="EGG">Engineering</option>
                                        <option value="ELEC">Electrical Technology</option>
                                        <option value="EMHS">Emergency Management and Homeland Security</option>
                                        <option value="EMS">Emergency Medical Services</option>
                                        <option value="ENG">English</option>
                                        <option value="ENV">Environmental Science</option>
                                        <option value="EPD">Emergency Preparedness</option>
                                        <option value="EPY">Educational Psychology</option>
                                        <option value="ESL">English as a Second Language</option>
                                        <option value="ET">Engineering Technology</option>
                                        <option value="FAB">Food and Beverage Management</option>
                                        <option value="FIL">Filipino</option>
                                        <option value="FIN">Finance</option>
                                        <option value="FLCV">Floriculture</option>
                                        <option value="FLOR">Floral Design</option>
                                        <option value="FMM">Fashion Merchandising Management</option>
                                        <option value="FREN">French</option>
                                        <option value="FT">Fire Technology</option>
                                        <option value="FUNS">Funeral Services</option>
                                        <option value="GAM">Gaming Management</option>
                                        <option value="GEOG">Geography</option>
                                        <option value="GEOL">Geology</option>
                                        <option value="GER">German</option>
                                        <option value="GIS">Geographic Information Systems</option>
                                        <option value="GLO">Global Studies</option>
                                        <option value="GLZR">Glazier</option>
                                        <option value="GRC">Graphic Communications</option>
                                        <option value="GRE">Greek</option>
                                        <option value="HAW">Hawaiian</option>
                                        <option value="HHP">Health and Human Performance</option>
                                        <option value="HIST">History</option>
                                        <option value="HIT">Health Information Technology</option>
                                        <option value="HMD">Hotel Management</option>
                                        <option value="HUM">Humanities</option>
                                        <option value="IRW">Integrated Reading and Writing</option>
                                        <option value="IS">Information Systems</option>
                                        <option value="ITAL">Italian</option>
                                        <option value="JOUR">Journalism</option>
                                        <option value="JPN">Japanese</option>
                                        <option value="KOR">Korean</option>
                                        <option value="LAS">Latin American Studies</option>
                                        <option value="LAT">Latin</option>
                                        <option value="LAW">Law</option>
                                        <option value="LIB">Library Science</option>
                                        <option value="MA">Medical Assisting</option>
                                        <option value="MATH">Mathematics</option>
                                        <option value="ME">Mechanical Engineering</option>
                                        <option value="MGT">Management</option>
                                        <option value="MHDD">Mental Health Directing and Development</option>
                                        <option value="MIL">Military Science</option>
                                        <option value="MKT">Marketing</option>
                                        <option value="MOT">Medical Office Technology</option>
                                        <option value="MT">Manufacturing Technology</option>
                                        <option value="MTT">Machine Tool Technology</option>
                                        <option value="MUS">Music</option>
                                        <option value="MUSA">Applied Music</option>
                                        <option value="MUSE">Music Ensembles</option>
                                        <option value="MWA">Metal Working Arts</option>
                                        <option value="NRES">Natural Resources</option>
                                        <option value="NURS">Nursing</option>
                                        <option value="NUTR">Nutrition</option>
                                        <option value="OPE">Operating Engineers</option>
                                        <option value="OPHT">Ophthalmic Technology</option>
                                        <option value="OPME">Operating Engineers Maintenance</option>
                                        <option value="PDA">Public Administration</option>
                                        <option value="PEX">Physical Education</option>
                                        <option value="PHAR">Pharmacy Technology</option>
                                        <option value="PHIL">Philosophy</option>
                                        <option value="PHO">Photography</option>
                                        <option value="PHYS">Physics</option>
                                        <option value="PLA">Paralegal Studies</option>
                                        <option value="PLCM">Plumbing</option>
                                        <option value="PN">Practical Nursing</option>
                                        <option value="PORT">Portuguese</option>
                                        <option value="PPF">Protective Services</option>
                                        <option value="PSC">Political Science</option>
                                        <option value="PSY">Psychology</option>
                                        <option value="PT">Physical Therapy</option>
                                        <option value="PTD">Physical Therapy Directing</option>
                                        <option value="RDTP">Radiation Therapy</option>
                                        <option value="RE">Real Estate</option>
                                        <option value="READ">Reading</option>
                                        <option value="RFR">Refrigeration</option>
                                        <option value="RST">Religious Studies</option>
                                        <option value="RUS">Russian</option>
                                        <option value="SCT">Surgical Technology</option>
                                        <option value="SEA">Southeast Asian Studies</option>
                                        <option value="SMTL">Sheet Metal Technology</option>
                                        <option value="SOC">Sociology</option>
                                        <option value="SON">Sonography</option>
                                        <option value="SPAN">Spanish</option>
                                        <option value="SRGT">Surgical Technology</option>
                                        <option value="STAT">Statistics</option>
                                        <option value="SUR">Surveying</option>
                                        <option value="TCA">Tourism and Convention Administration</option>
                                        <option value="THAI">Thai</option>
                                        <option value="THTR">Theatre</option>
                                        <option value="TLS">Transitional Learning Skills</option>
                                        <option value="TMST">Transportation Management</option>
                                        <option value="URST">Urban Studies</option>
                                        <option value="VETN">Veterinary Nursing</option>
                                        <option value="VID">Videography</option>
                                        <option value="WELD">Welding</option>
                                        <option value="WMST">Women's Studies</option>
                                        <option value="WWT">Water/Wastewater Technology</option>
                                    </select>
                                </div>

                                <div class="filter-group">
                                    <label for="hideFullCheckbox">
                                        <input type="checkbox" id="hideFullCheckbox"
                                               onchange="filterExams('registration')" checked>
                                        Hide Full Exams
                                    </label>
                                </div>
                            </div>
                            <div class="exam-limit-counter">
                                Registered: <span id="exam-count">0</span> / 3
                            </div>
                        </div>

                        <!-- Dynamic Exam List -->
                        <div id="registration-panel">
                            <!-- Registration cards will be loaded here via fetch_registration_html -->
                        </div>
                    </div>

                    <div id="confirmation-card" class="hidden">
                        <h1>Exam Confirmation</h1>
                        <!-- Dynamic Exam List -->
                        <div id="exam-confirmation"></div>

                    </div>


                    <div id="bookings-card" class="hidden">
                        <h1>Bookings</h1>
                        <!-- Dynamic Exam List -->
                        <div id="bookings-list">
                            <!-- Booking cards will be loaded here via fetch_bookings_html -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        function queueExamForConfirmation(button) {
            const examId = button.getAttribute("data-exam-id");

            fetch(`/queue_exam/${examId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                    "X-Requested-With": "XMLHttpRequest"
                }
            })

            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    refreshRegistrationList();
                    showSnackbar("Exam was sent to Exam Confirmations.");
                    updateExamCount();
                }
            });
        }


        function confirmEnrollment(button) {
            const examId = button.getAttribute("data-exam-id");

            fetch("/get_exam_count/")
                .then(res => res.json())
                .then(data => {
                    if (data.count >= 3) {
                        showSnackbar("You’ve already confirmed the maximum of 3 exams.");
                        return;
                    }

                    fetch(`/confirm_queued_exam/${examId}/`, {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": getCookie("csrftoken"),
                            "X-Requested-With": "XMLHttpRequest"
                        }
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            refreshConfirmationList();
                            showSnackbar("Exam confirmed! Check your booked exams in My Bookings.");
                            updateExamCount();
                        } else {
                            showSnackbar(data.error || "Failed to confirm exam.");
                        }
                    });
                });
        }

        function clearActiveLinks() {
            document.querySelectorAll(".nav-link").forEach(link => {
                link.classList.remove("active");
            });

            // Hide all cards
            document.querySelectorAll(".content-card > div").forEach(panel => {
                panel.classList.add("hidden");
            });
        }


        function showDashboard() {
            clearActiveLinks();
            document.getElementById("dashboard").classList.add("active");
            document.getElementById("dashboard-card").classList.remove("hidden");
            document.getElementById("registration-card").classList.add("hidden");
            document.getElementById("bookings-card").classList.add("hidden");
            document.getElementById("confirmation-card").classList.add("hidden");
        }

        function showRegistration() {
            clearActiveLinks();
            document.getElementById("registration").classList.add("active");
            document.getElementById("dashboard-card").classList.add("hidden");
            document.getElementById("registration-card").classList.remove("hidden");
            document.getElementById("bookings-card").classList.add("hidden");
            document.getElementById("confirmation-card").classList.add("hidden");

            refreshRegistrationList();
            updateExamCount();
        }

        function showBookings() {
            clearActiveLinks();
            document.getElementById("bookings").classList.add("active");
            document.getElementById("dashboard-card").classList.add("hidden");
            document.getElementById("registration-card").classList.add("hidden");
            document.getElementById("confirmation-card").classList.add("hidden");
            document.getElementById("bookings-card").classList.remove("hidden");

            refreshBookingsList();
        }

        function showConfirmations() {
            clearActiveLinks();
            document.getElementById("confirmation").classList.add("active");
            document.getElementById("dashboard-card").classList.add("hidden");
            document.getElementById("registration-card").classList.add("hidden");
            document.getElementById("bookings-card").classList.add("hidden");
            document.getElementById("confirmation-card").classList.remove("hidden");

            refreshConfirmationList();
        }



        function filterExams(panel) {
            const selectedCampus = document.getElementById(`campusFilter-${panel}`).value;
            const startDateInput = document.getElementById(`startDate-${panel}`);
            const endDateInput = document.getElementById(`endDate-${panel}`);
            const selectedSubject = document.getElementById(`subjectFilter-${panel}`)?.value || "all";
            const hideFull = document.getElementById("hideFullCheckbox")?.checked ?? true;


            let startDate = null;
            let endDate = null;

            if (startDateInput?.value) {
                const sParts = startDateInput.value.split("-");
                startDate = new Date(sParts[0], sParts[1] - 1, sParts[2]); // local midnight
            }

            if (endDateInput?.value) {
                const eParts = endDateInput.value.split("-");
                endDate = new Date(eParts[0], eParts[1] - 1, eParts[2]);
                endDate.setHours(23, 59, 59, 999); // include full end-of-day
            }

            const examCards = document.querySelectorAll(`#${panel}-card .exam-card`);

            examCards.forEach(card => {
                const cardCampus = card.getAttribute('data-campus');
                const cardDateStr = card.getAttribute('data-date');
                const cardSubject = card.getAttribute('data-subject');

                if (!cardDateStr) return; // Skip if date is missing

                let cardDate = null;
                if (cardDateStr && cardDateStr.includes("-")) {
                    const parts = cardDateStr.split("-");
                    if (parts.length === 3) {
                        cardDate = new Date(parts[0], parts[1] - 1, parts[2]);
                    }
                }

                if (!cardDate || isNaN(cardDate.getTime())) {
                    console.warn("Invalid cardDate:", cardDateStr);
                    card.style.display = 'none';
                    return;
                }


                const campusMatches = (selectedCampus === "all" || cardCampus === selectedCampus);
                const subjectMatches = (selectedSubject === "all" || cardSubject === selectedSubject);

                const isFull = card.getAttribute('data-full') === "true";
                const fullMatches = !hideFull || !isFull;

                let dateMatches = true;
                if (startDate && cardDate < startDate) dateMatches = false;
                if (endDate && cardDate > endDate) dateMatches = false;

                console.log("CARD:", cardDate.toISOString(),
                            "| Start:", startDate?.toISOString(),
                            "| End:", endDate?.toISOString(),
                            "| dateMatches:", dateMatches);

                if (campusMatches && dateMatches && subjectMatches && fullMatches) {
                    card.style.removeProperty('display');
                } else {
                    card.style.display = 'none';
                }

            });
        }

        function cancelExam(button) {
            const examId = button.getAttribute("data-exam-id");

            fetch(`/cancel_exam/${examId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                    "X-Requested-With": "XMLHttpRequest"
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (!document.getElementById("registration-card").classList.contains("hidden")) {
                        refreshRegistrationList();
                    } else if (!document.getElementById("confirmation-card").classList.contains("hidden")) {
                        refreshConfirmationList();
                    } else if (!document.getElementById("bookings-card").classList.contains("hidden")) {
                        refreshBookingsList();
                    }
                    updateExamCount();
                } else {
                    alert(data.error || "Failed to cancel exam.");
                }
            })
            .catch(err => {
                console.error("Error canceling exam:", err);
            });
        }

        // CSRF helper for Django
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === name + "=") {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function refreshRegistrationList() {
            console.log("REFRESHING REGISTRATION PANEL");

            const regList = document.querySelector("#registration-panel");

            // Clear the panel immediately
            if (regList) {
                regList.innerHTML = "";

                // Create and insert the spinner directly into the panel
                const spinnerWrapper = document.createElement("div");
                spinnerWrapper.className = "spinner-wrapper";

                const spinnerContainer = document.createElement("div");
                spinnerContainer.className = "spinner-container";

                const spinner = document.createElement("div");
                spinner.className = "spinner";

                spinnerContainer.appendChild(spinner);
                spinnerWrapper.appendChild(spinnerContainer);
                regList.appendChild(spinnerWrapper);
            }

            // Fetch and replace content
            setTimeout(() => {
                fetch("/fetch_registration_html/")
                    .then(response => response.json())
                    .then(data => {
                        if (regList && data.html) {
                            regList.innerHTML = data.html;
                            filterExams("registration");
                        }
                    })
                    .catch(err => {
                        console.error("Error refreshing registration list:", err);
                    });
            }, 0);
        }

        function refreshBookingsList() {
            console.log("REFRESHING BOOKINGS PANEL");

            const bookingsList = document.querySelector("#bookings-list");

            // Clear the panel immediately
            if (bookingsList) {
                bookingsList.innerHTML = "";

                // Create and insert the spinner directly into the panel
                const spinnerWrapper = document.createElement("div");
                spinnerWrapper.className = "spinner-wrapper";

                const spinnerContainer = document.createElement("div");
                spinnerContainer.className = "spinner-container";

                const spinner = document.createElement("div");
                spinner.className = "spinner";

                spinnerContainer.appendChild(spinner);
                spinnerWrapper.appendChild(spinnerContainer);
                bookingsList.appendChild(spinnerWrapper);
            }

            // Fetch and replace content
            setTimeout(() => {
                fetch("/fetch_bookings_html/")
                    .then(response => response.json())
                    .then(data => {
                        if (bookingsList && data.html) {
                            bookingsList.innerHTML = data.html;
                        }
                    })
                    .catch(err => {
                        console.error("Error refreshing bookings list:", err);
                    });
            }, 0);
        }

        function refreshConfirmationList() {
            console.log("REFRESHING CONFIRMATIONS PANEL");

            const confirmationList = document.querySelector("#exam-confirmation");

            // Clear the panel immediately
            if (confirmationList) {
                confirmationList.innerHTML = "";

                // Create and insert the spinner directly into the panel
                const spinnerWrapper = document.createElement("div");
                spinnerWrapper.className = "spinner-wrapper";

                const spinnerContainer = document.createElement("div");
                spinnerContainer.className = "spinner-container";

                const spinner = document.createElement("div");
                spinner.className = "spinner";

                spinnerContainer.appendChild(spinner);
                spinnerWrapper.appendChild(spinnerContainer);
                confirmationList.appendChild(spinnerWrapper);
            }

            // Fetch and replace content
            setTimeout(() => {
                fetch("/fetch_confirmation_html/")
                    .then(response => response.json())
                    .then(data => {
                        if (confirmationList && data.html) {
                            confirmationList.innerHTML = data.html;
                        }
                    })
                    .catch(err => {
                        console.error("Error refreshing confirmations list:", err);
                    });
            }, 0);
        }

        function updateExamCount() {
            fetch("/get_exam_count/")
                .then(res => res.json())
                .then(data => {
                    document.getElementById("exam-count").textContent = data.count;
                });
        }

        function showSnackbar(message) {
            const snackbar = document.getElementById("snackbar");
            snackbar.textContent = message;

            snackbar.classList.remove("show"); // Reset in case it's already showing
            void snackbar.offsetWidth;         // Force reflow
            snackbar.classList.add("show");

            setTimeout(() => {
                snackbar.classList.remove("show");
            }, 3000);
        }

        const announcements = [
            "Confirm your May exams by April 28.",
            "Charleston Testing Center closed May 12–14.",
            "Photo ID required on exam day.",
            "Fall semester exam slots now open.",
            "Exam capacity increased to 25 seats.",
            "North Las Vegas Campus now available for BIO 189.",
            "Cancel exams at least 48 hours in advance.",
            "No exams scheduled May 6–10 for Advising Week."
        ];

        let current = 0;
        let autoRotate;

        function showAnnouncement(index) {
            const textDiv = document.getElementById("announcement-text");
            textDiv.textContent = announcements[index];
        }

        function nextAnnouncement() {
            current = (current + 1) % announcements.length;
            showAnnouncement(current);
            resetTimer();
        }

        function prevAnnouncement() {
            current = (current - 1 + announcements.length) % announcements.length;
            showAnnouncement(current);
            resetTimer();
        }

        function resetTimer() {
            clearInterval(autoRotate);
            autoRotate = setInterval(nextAnnouncement, 6000);
        }

        window.onload = () => {
            showAnnouncement(current);
            autoRotate = setInterval(nextAnnouncement, 6000);
        };

    </script>

    <div id="snackbar"></div>

</body>
</html>