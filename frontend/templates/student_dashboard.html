{% load static %}
{% load sass_tags %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome CDN -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" >
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Exam Dashboard</title>
    <link rel="stylesheet" href="{% sass_src 'scss/student_dashboard.scss' %}">
</head>

<body>
    <div class="dashboard-container">

        <!-- Top Navigation Bar -->
        <header class="top-bar">
        <div class="logo">
            <img src="{% static 'images/csn_logo.png' %}" alt="Website Logo">
        </div>
        <div class="top-center">Student Dashboard</div> <!-- Or Campus Name, Date, etc. -->
        <div class="account-area">
            <a href="{% url 'logout' %}">Log Out</a>
        </div>
        </header>

        <!-- Sidebar + Main Content Area -->
        <div class="main-layout">

            <nav class="sidebar">
                <ul>
                    <!-- Add more links as needed -->
                    <li><a href="#" id="dashboard" class="nav-link active" onclick="showDashboard()">
                        <span class="icon"><i class="fas fa-house"></i></span>
                        <span class="label">Dashboard</span>
                    </a></li>

                    <li><a href="#" id="registration" class="nav-link" onclick="showRegistration()">
                        <span class="icon"><i class="fas fa-pen-to-square"></i></span>
                        <span class="label">Register for an Exam</span>
                    </a></li>

                    <li><a href="#" id="bookings" class="nav-link" onclick="showBookings()">
                        <span class="icon"><i class="fas fa-file-alt"></i></span>
                        <span class="label">My Bookings</span>
                    </a></li>

                    <li><a href="#" id="confirmation" class="nav-link" onclick="showConfirmations()">
                        <span class="icon"><i class="fas fa-circle-check"></i></span>
                        <span class="label">Exam Confirmation</span>
                    </a></li>
                </ul>
            </nav>

            <main class="main-window">
                <div class="content-card">
                    <!-- Dynamic exam cards or booking UI goes here -->
                    <div id="dashboard-card">
                        <h1>Welcome, {{ first_name }} {{ last_name }}</h1>
                    </div>

                    <div id="registration-card" class="hidden">
                        <h1>Exam Registration</h1>

                        <!-- Filters -->
                        <div class="filters-row">
                            <div class="filters">
                                <div class="filter-group">
                                    <label for="startDate-registration">From:</label>
                                    <input type="date" id="startDate-registration" onchange="filterExams('registration')">
                                </div>

                                <div class="filter-group">
                                    <label for="endDate-registration">To:</label>
                                    <input type="date" id="endDate-registration" onchange="filterExams('registration')">
                                </div>

                                <div class="filter-group">
                                    <label for="campusFilter-registration">Campus:</label>
                                    <select id="campusFilter-registration" onchange="filterExams('registration')">
                                        <option value="all">All Campuses</option>
                                        <option value="Henderson">Henderson</option>
                                        <option value="North Las Vegas">North Las Vegas</option>
                                        <option value="West Charleston">West Charleston</option>
                                    </select>
                                </div>

                                <div class="filter-group">
                                    <label for="subjectFilter-registration">Subject:</label>
                                    <select id="subjectFilter-registration" onchange="filterExams('registration')">
                                        <option value="all">All Subjects</option>
                                        <option value="MATH">MATH</option>
                                        <option value="ENG">ENG</option>
                                        <option value="BIO">BIO</option>
                                        <!-- Add more subjects as needed -->
                                    </select>
                                </div>

                                <div class="filter-group">
                                    <label for="hideFullCheckbox">
                                        <input type="checkbox" id="hideFullCheckbox"
                                               onchange="filterExams('registration')" checked>
                                        Hide Full Exams
                                    </label>
                                </div>


                            </div>

                            <div class="exam-limit-counter">
                                Registered: <span id="exam-count">0</span> / 3
                            </div>

                        </div>

                        <!-- Dynamic Exam List -->
                        <div class="exam-list grid-view">
                            <!-- Registration cards will be loaded here via fetch_registration_html -->
                        </div>
                    </div>

                    <div id="confirmation-card" class="hidden">
                        <h1>Exam Confirmation</h1>
                        <!-- Dynamic Exam List -->
                        <div id="exam-confirmation" class="exam-list grid-view"></div>

                    </div>


                    <div id="bookings-card" class="hidden">
                        <h1>Bookings</h1>
                        <!-- Dynamic Exam List -->
                        <div class="exam-list grid-view">
                            <!-- Booking cards will be loaded here via fetch_bookings_html -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>

        let pendingExamId = null;

        function queueExamForConfirmation(button) {
            const examId = button.getAttribute("data-exam-id");
            pendingExamId = examId;

            fetch(`/fetch_confirmation_html/${examId}/`)
                .then(response => response.json())
                .then(data => {
                    const details = document.getElementById("confirmation-details");
                    details.innerHTML = data.html;
                    showConfirmations();
                })
                .catch(err => {
                    console.error("Error fetching confirmation HTML:", err);
                });
        }


        function confirmEnrollment() {
            if (!pendingExamId) return;

            fetch(`/enroll_exam/${pendingExamId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                    "X-Requested-With": "XMLHttpRequest"
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    pendingExamId = null;
                    showBookings(); // go to bookings after confirmation
                    updateExamCount();
                } else {
                    showSnackbar(data.error || "Failed to enroll.");
                }
            })
            .catch(err => {
                console.error("Error enrolling in exam:", err);
            });
        }

        function cancelConfirmation() {
            pendingExamId = null;
            showRegistration(); // go back to registration
        }


        function clearActiveLinks() {
            document.querySelectorAll(".nav-link").forEach(link => {
                link.classList.remove("active");
            });
        }

        function showDashboard() {
            clearActiveLinks();
            document.getElementById("dashboard").classList.add("active");
            document.getElementById("dashboard-card").classList.remove("hidden");
            document.getElementById("registration-card").classList.add("hidden");
            document.getElementById("bookings-card").classList.add("hidden");
        }

        function showRegistration() {
            clearActiveLinks();
            document.getElementById("registration").classList.add("active");
            document.getElementById("dashboard-card").classList.add("hidden");
            document.getElementById("registration-card").classList.remove("hidden");
            document.getElementById("bookings-card").classList.add("hidden");

            refreshRegistrationList();
            updateExamCount();
        }

        function showBookings() {
            clearActiveLinks();
            document.getElementById("bookings").classList.add("active");
            document.getElementById("dashboard-card").classList.add("hidden");
            document.getElementById("registration-card").classList.add("hidden");
            document.getElementById("bookings-card").classList.remove("hidden");

            // Fetch the latest bookings
            fetch("/fetch_bookings_html/")
                .then(response => response.json())
                .then(data => {
                    document.querySelector("#bookings-card .exam-list").outerHTML = data.html;
                })
                .catch(err => {
                    console.error("Error fetching bookings:", err);
                });
        }

        function showConfirmations() {
            clearActiveLinks();
            document.getElementById("confirmation").classList.add("active");
            document.getElementById("dashboard-card").classList.add("hidden");
            document.getElementById("registration-card").classList.add("hidden");
            document.getElementById("bookings-card").classList.add("hidden");
            document.getElementById("confirmation-card").classList.remove("hidden");
}


        function filterExams(panel) {
            const selectedCampus = document.getElementById(`campusFilter-${panel}`).value;
            const startDateInput = document.getElementById(`startDate-${panel}`);
            const endDateInput = document.getElementById(`endDate-${panel}`);
            const selectedSubject = document.getElementById(`subjectFilter-${panel}`)?.value || "all";
            const hideFull = document.getElementById("hideFullCheckbox")?.checked ?? true;


            let startDate = null;
            let endDate = null;

            if (startDateInput?.value) {
                const sParts = startDateInput.value.split("-");
                startDate = new Date(sParts[0], sParts[1] - 1, sParts[2]); // local midnight
            }

            if (endDateInput?.value) {
                const eParts = endDateInput.value.split("-");
                endDate = new Date(eParts[0], eParts[1] - 1, eParts[2]);
                endDate.setHours(23, 59, 59, 999); // include full end-of-day
            }

            const examCards = document.querySelectorAll(`#${panel}-card .exam-card`);

            examCards.forEach(card => {
                const cardCampus = card.getAttribute('data-campus');
                const cardDateStr = card.getAttribute('data-date');
                const cardSubject = card.getAttribute('data-subject');

                if (!cardDateStr) return; // Skip if date is missing

                let cardDate = null;
                if (cardDateStr && cardDateStr.includes("-")) {
                    const parts = cardDateStr.split("-");
                    if (parts.length === 3) {
                        cardDate = new Date(parts[0], parts[1] - 1, parts[2]);
                    }
                }

                if (!cardDate || isNaN(cardDate.getTime())) {
                    console.warn("Invalid cardDate:", cardDateStr);
                    card.style.display = 'none';
                    return;
                }


                const campusMatches = (selectedCampus === "all" || cardCampus === selectedCampus);
                const subjectMatches = (selectedSubject === "all" || cardSubject === selectedSubject);

                const isFull = card.getAttribute('data-full') === "true";
                const fullMatches = !hideFull || !isFull;

                let dateMatches = true;
                if (startDate && cardDate < startDate) dateMatches = false;
                if (endDate && cardDate > endDate) dateMatches = false;

                console.log("CARD:", cardDate.toISOString(),
                            "| Start:", startDate?.toISOString(),
                            "| End:", endDate?.toISOString(),
                            "| dateMatches:", dateMatches);

                if (campusMatches && dateMatches && subjectMatches && fullMatches) {
                    card.style.removeProperty('display');
                } else {
                    card.style.display = 'none';
                }

            });
        }

        function cancelExam(button) {
            const examId = button.getAttribute("data-exam-id");

            fetch(`/cancel_exam/${examId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                    "X-Requested-With": "XMLHttpRequest"
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the card or update the button
                    const card = button.closest(".exam-card");
                    if (card) {
                        card.remove();
                    }
                    refreshRegistrationList();
                    updateExamCount();
                } else {
                    alert(data.error || "Failed to cancel exam.");
                }
            })
            .catch(err => {
                console.error("Error canceling exam:", err);
            });
        }

        // CSRF helper for Django
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === name + "=") {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function enrollExam(button) {

            fetch("/get_exam_count/")
                .then(res => res.json())
                .then(data => {
                    if (data.count >= 3) {
                        showSnackbar("Youâ€™ve already registered for the maximum of 3 exams.");
                        return;
                    }

                const examId = button.getAttribute("data-exam-id");

                fetch(`/enroll_exam/${examId}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": getCookie("csrftoken"),
                        "X-Requested-With": "XMLHttpRequest"
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove the card or replace content
                        const card = button.closest(".exam-card");
                        if (card) {
                            card.remove(); // or update it visually
                        }
                        refreshRegistrationList();
                        updateExamCount();
                    } else {
                        alert(data.error || "Failed to enroll.");
                    }
                })
                .catch(err => {
                    console.error("Error enrolling in exam:", err);
                });
            })
        }

        function refreshRegistrationList() {
            console.log("REFRESHING REGISTRATION PANEL");
            fetch("/fetch_registration_html/")
                .then(response => response.json())
                .then(data => {
                    const regList = document.querySelector("#registration-card .exam-list");
                    if (regList && data.html) {
                        regList.outerHTML = data.html;

                        filterExams('registration');
                    }
                })
                .catch(err => {
                    console.error("Error refreshing registration list:", err);
                });
        }

        function updateExamCount() {
            fetch("/get_exam_count/")
                .then(res => res.json())
                .then(data => {
                    document.getElementById("exam-count").textContent = data.count;
                });
        }

        function showSnackbar(message) {
            const snackbar = document.getElementById("snackbar");
            snackbar.textContent = message;

            snackbar.classList.remove("show"); // Reset in case it's already showing
            void snackbar.offsetWidth;         // Force reflow
            snackbar.classList.add("show");

            setTimeout(() => {
                snackbar.classList.remove("show");
            }, 3000);
        }
    </script>

    <div id="snackbar"></div>

</body>
</html>
